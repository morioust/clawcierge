<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ agent.display_name }} - Clawcierge Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; background: #f5f5f5; padding: 2rem; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        h1 { font-size: 1.5rem; color: #333; }
        a.back { color: #2563eb; text-decoration: none; font-size: 0.875rem; }
        a.back:hover { text-decoration: underline; }
        .logout { color: #2563eb; text-decoration: none; font-size: 0.875rem; }
        .logout:hover { text-decoration: underline; }
        .card { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
        .card h2 { font-size: 1.1rem; color: #333; margin-bottom: 1rem; }
        .meta-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1rem; }
        .meta-item label { display: block; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #888; margin-bottom: 0.2rem; }
        .meta-item .value { font-size: 0.9rem; color: #333; word-break: break-all; }
        .status { display: inline-block; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
        .status-active { background: #dcfce7; color: #166534; }
        .status-inactive { background: #f3f4f6; color: #6b7280; }
        .capability { border: 1px solid #e5e7eb; border-radius: 6px; padding: 1rem; margin-bottom: 0.75rem; }
        .capability:last-child { margin-bottom: 0; }
        .capability-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .capability-action { font-weight: 600; font-size: 0.95rem; color: #111; font-family: monospace; }
        .schema-block { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 4px; padding: 0.75rem; font-family: monospace; font-size: 0.8rem; white-space: pre-wrap; word-break: break-word; color: #374151; overflow-x: auto; }
        .sub-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #888; margin: 0.5rem 0 0.25rem; }
        .rule { border: 1px solid #e5e7eb; border-radius: 6px; padding: 1rem; margin-bottom: 0.75rem; }
        .rule:last-child { margin-bottom: 0; }
        .rule-condition { font-family: monospace; font-size: 0.85rem; color: #111; margin-bottom: 0.25rem; }
        .rule-meta { font-size: 0.8rem; color: #666; }
        .rule-action-reject { color: #dc2626; font-weight: 500; }
        .rule-action-allow { color: #16a34a; font-weight: 500; }
        .empty-section { color: #999; font-size: 0.875rem; padding: 0.5rem 0; }
        .delete-section { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #fee2e2; }
        .btn-delete { background: #dc2626; color: #fff; border: none; padding: 0.4rem 1rem; border-radius: 4px; font-size: 0.85rem; cursor: pointer; }
        .btn-delete:hover { background: #b91c1c; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <a href="/admin/" class="back">&larr; All agents</a>
            <h1>{{ agent.display_name }}</h1>
        </div>
        <a href="/admin/logout" class="logout">Log out</a>
    </div>

    <div class="card">
        <h2>Details</h2>
        <div class="meta-grid">
            <div class="meta-item">
                <label>Handle</label>
                <div class="value">{{ agent.handle.handle if agent.handle else "—" }}</div>
            </div>
            <div class="meta-item">
                <label>Agent ID</label>
                <div class="value">{{ agent.id }}</div>
            </div>
            <div class="meta-item">
                <label>Status</label>
                <div class="value"><span class="status status-{{ agent.status }}">{{ agent.status }}</span></div>
            </div>
            <div class="meta-item">
                <label>Created</label>
                <div class="value">{{ agent.created_at.strftime("%Y-%m-%d %H:%M UTC") }}</div>
            </div>
            <div class="meta-item">
                <label>Last Updated</label>
                <div class="value">{{ agent.updated_at.strftime("%Y-%m-%d %H:%M UTC") }}</div>
            </div>
            <div class="meta-item">
                <label>Last Heartbeat</label>
                <div class="value">{{ heartbeat or "—" }}</div>
            </div>
            <div class="meta-item">
                <label>Owner ID</label>
                <div class="value">{{ agent.owner_id }}</div>
            </div>
            <div class="meta-item">
                <label>Connected</label>
                <div class="value">{{ "Yes" if is_connected else "No" }}</div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>Capabilities{% if active_contract %} <span style="font-weight:normal;font-size:0.8rem;color:#888;">(v{{ active_contract.version }})</span>{% endif %}</h2>
        {% if capabilities %}
            {% for cap in capabilities %}
            <div class="capability">
                <div class="capability-header">
                    <span class="capability-action">{{ cap.action }}</span>
                </div>
                {% if cap.params_schema %}
                <div class="sub-label">Parameters schema</div>
                <div class="schema-block">{{ cap.params_schema | tojson(indent=2) }}</div>
                {% endif %}
                {% if cap.constraints %}
                <div class="sub-label">Constraints</div>
                <div class="schema-block">{{ cap.constraints | tojson(indent=2) }}</div>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-section">No capabilities defined.</div>
        {% endif %}
    </div>

    <div class="card">
        <h2>Policies{% if active_policy %} <span style="font-weight:normal;font-size:0.8rem;color:#888;">(v{{ active_policy.version }})</span>{% endif %}</h2>
        {% if policy_rules %}
            {% for rule in policy_rules %}
            <div class="rule">
                <div class="rule-condition">{{ rule.condition }}</div>
                <div class="rule-meta">
                    Action: <span class="rule-action-{{ rule.action }}">{{ rule.action }}</span>
                    {% if rule.reason %} &mdash; {{ rule.reason }}{% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-section">No policy rules defined.</div>
        {% endif %}
    </div>

    <div class="card">
        <div class="delete-section" style="border-top:none;margin-top:0;padding-top:0;">
            <form method="post" action="/admin/agents/{{ agent.id }}/delete" onsubmit="return confirm('Delete this agent? This cannot be undone.')">
                <button type="submit" class="btn-delete">Delete agent</button>
            </form>
        </div>
    </div>
</body>
</html>
